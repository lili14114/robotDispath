*** Settings ***
Library           Selenium2Library
Library           CustomLibrary
Library           Collections
Library           RequestsLibrary
Resource          公共方法.txt
Variables         setting.py

*** Keywords ***
打开简图调度
    select window    ${window}
    click element    &{menuDict}[operative_monitor]    #【运营监控】
    sleep    1    #
    click element    &{menuDict}[diagram_disapth]    #【简图调度】
    sleep    3
    click element    ${roadXpath_diagram}    #37路100
    sleep    5

切换简图domain_frame
    #切换到简图调度frame
    Wait Until Element Is Enabled    ${iframe_tab}    #切换到37路100的主frame
    Select Frame    ${iframe_tab}    #切换到37路100的主frame
    sleep    2

获取简图车辆更多菜单
    [Arguments]    ${bustid}    ${dropDownPath}
    #前提需处于domain_frame
    ${bustidXPATH}    Catenate    SEPARATOR=    css=div[id='    ${bustid}    ']>div[class='bus-body']
    Wait Until Element Is Enabled    ${iframe_line}    #切到37路100的简图模拟图frame
    Select Frame    ${iframe_line}
    sleep    1
    Right Click Element    ${bustidXPATH}    #车辆bustid
    sleep    2
    unselect Frame
    Select Frame    ${iframe_tab}    #切回主frame
    sleep    1
    click element    ${dropDownPath}
    sleep    1

获取简图车辆更多菜单index
    [Arguments]    ${bustid}    ${dropDownPath}    ${index}
    [Documentation]    不能直接获取的更多菜单，需要指定获取哪个元素时使用
    ...    例如：简图车辆更多菜单-“路单”，“司机”
    ...    busReport=xpath=//a[contains(text(),"路单") and @tabindex='-1']#路单，取最后一个
    ...    driver=xpath=//a[contains(text(),"司机") and @tabindex='-1']#司机 ，取最后一个
    ...
    ...
    #打开简图调度
    #切换简图domain_frame
    ${bustidXPATH}    Catenate    SEPARATOR=    css=div[id='    ${bustid}    ']>div[class='bus-body']
    Wait Until Element Is Enabled    ${iframe_line}    #切到37路100的简图模拟图frame
    Select Frame    ${iframe_line}
    sleep    1
    Right Click Element    ${bustidXPATH}    #车辆bustid
    sleep    2
    unselect Frame
    Select Frame    ${iframe_tab}    #切回主frame
    sleep    1
    ${elements}    Get WebElements    ${dropDownPath}    #获取简图-车辆-路单按钮&{dropdown_menuDict}[busReport]
    click element    ${elements}[${index}]    #选择点击简图上的路单(index=-1)
    sleep    1

获取简图调度字轨表中的排班时间
    [Documentation]    \#前提打开简图调度
    ...
    ...
    ...    获取简图调度字轨表中的排班时间
    #以下步骤需进入简图调度domain_frame中操作，即
    #Select Frame    &{frame}[domain_frame]
    click element    xpath=//div[contains(text(),'排班间隔')]    #简图上方“排班间隔”
    sleep    2
    ${plantimeCount}    get element count    xpath=//label[@style='color:#4c4c4c;' or @style='color:#00BA00;']    #返回元素的个数，即字轨表中有多少个排班时间
    Set Global Variable    ${plantimeCount}
    @{plantimeElements}    get webelements    xpath=//label[@style='color:#4c4c4c;' or @style='color:#00BA00;']    #返回多个元素.@style='color:#4c4c4c;' 代表已过期时间。@style='color:#00BA00;' 代表未来时间
    Set Global Variable    @{plantimeElements}
    FOR    ${plan}    IN    @{plantimeElements}
        ${time}    get text    ${plan}
        log    ${time}
    END
    click element    xpath=//button[contains(text(),"返回")]    #关闭字轨表页面

三台车手动进站获取排班时间
    [Arguments]    @{bustidLst}
    @{plantimeLst}    create list    #创建plantimeLst列表
    Set Global Variable    @{plantimeLst}
    #创建车辆Lst
    #定位两个变量定位器
    FOR    ${bustid}    IN    @{bustidLst}
        ${bustidXPATH_2}    Catenate    SEPARATOR=    xpath=//div[@id='DownStationList']/div[@id='    ${bustid}    ']/div[@class='init-plantime alpha-bg']
        切换简图domain_frame
        获取简图车辆更多菜单    ${bustid}    &{dropdown_menuDict}[goToSite]
        click element    xpath=//button[@id='save']    #对车辆手动“进站”保存
        sleep    3
        Wait Until Element Is Enabled    ${iframe_line}
        Select Frame    ${iframe_line}
        ${plantime}    get text    ${bustidXPATH_2}    #尝试获取简图上该车辆当前排班计划
        unselect frame
        Append to list    ${plantimeLst}    ${plantime}    #将三台车的排班时间装入到LST当中，用于后续的结果验证
    END
    log many    @{plantimeLst}
    List Should Not Contain Duplicates    ${plantimeLst}    #判断列表中是否存在重复数据，如果出现重复数据，则判断为False.注意此方法在引用变量时，要使用$前缀
    #车辆停运再恢复运营，恢复测试初状态
    @{hostcodeLst}    create List    ${bus_1}[hostcode]    ${bus_2}[hostcode]    ${bus_3}[hostcode]
    车辆停运再恢复运营    @{hostcodeLst}

车辆手动进站
    [Arguments]    @{varLst}
    #车辆手动进站
    #@{varLst}    create list    ${bustid}    ${FLAG}
    获取简图车辆更多菜单    @{varLst}[0]    &{dropdown_menuDict}[goToSite]
    ${flag}    set variable    @{varLst}[1]
    run keyword if    '${flag}'=='default'    click element    xpath=//button[@id='save']
    ...    ELSE    车辆进左总站    #直接手动进站，对车辆手动“进站”保存    #此时frame停留在domain_frame中

获取”待执行“路单更多菜单
    [Arguments]    ${menu_css}
    #打开简图调度
    Right Click Element    xpath=//div[@id='road_order_detail_grid2_417768025']//tr[@data-index="0"]
    #获取第一条待执行的路单
    sleep    2
    Right Click Element    css=${menu_css}
    sleep    1

查询简图监控车辆图标旁待执行排班时间
    [Arguments]    @{bustidLst}
    @{plantimeList}    create list    #创建plantimeLst列表
    FOR    ${bustid}    IN    @{bustidLst}
        ${bustidXPATH_2}    Catenate    SEPARATOR=    xpath=//div[@id='DownStationList']/div[@id='    ${bustid}    ']/div[@class='init-plantime alpha-bg']
        切换简图domain_frame
        Wait Until Element Is Enabled    ${iframe_line}
        Select Frame    ${iframe_line}
        ${plantime}    get text    ${bustidXPATH_2}    #尝试获取简图上该车辆当前排班计划
        unselect frame
        Append to list    ${plantimeList}    ${plantime}    #将三台车的排班时间装入到LST当中，用于后续的结果验证
    END
    [Return]    @{plantimeList}

车辆停运再恢复运营
    [Arguments]    @{hostcodeLst}
    FOR    ${hostcode}    IN    @{hostcodeLst}
        ${caronline}    Get Caronline Json    ${hostcode}
        ${dispathJson}    Get Dispath Json    ${hostcode}    6
    #车辆上线
        #    ${data}    post request    api    /webservice/rest/caronline    data=${caronline}
        #    ${result}    To Json    ${data.content}
        #    should contain    ${result}[error_text]    上报成功
    #车辆上传指令
        ${data2}    post request    api    /webservice/rest/dispatch    data=${dispathJson}
        ${result2}    To Json    ${data2.content}
        should contain    ${result2}[error_text]    上报成功
        sleep    3
        ${dispathJson}    Get Dispath Json    ${hostcode}    106
        ${data3}    post request    api    /webservice/rest/dispatch    data=${dispathJson}
        ${result3}    To Json    ${data3.content}
        should contain    ${result3}[error_text]    上报成功
        sleep    3
    END

车辆进左总站
    click element    xpath=//div[@id='phrase_templateID']/button[@class='btn btn-default dropdown-toggle']
    ${elements}    Get WebElements    xpath=//ul[@role='menu']/li[@class='selected']/a
    click element    ${elements}[1]    #点击第二个站点
    sleep    1
    click element    xpath=//button[@id='save']    #对车辆手动“进站”保存    #此时frame停留在domain_frame中

回到简图调度
    [Documentation]    已在其他页面需要回到简图调度页面
    ...    例如：在行车记录页面操作后，要回到简图调度页面
    unselect frame    #回到简图调度页面
    click element    &{menuDict}[diagram_disapth]    #【简图调度】
    sleep    3
    click element    ${roadXpath_diagram}    #37路100
    sleep    5
    切换简图domain_frame
